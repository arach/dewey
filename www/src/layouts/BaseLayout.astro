---
import '../styles/global.css'
import SiteHeader from '../components/SiteHeader.astro'

interface Props {
  title?: string
  hideSearch?: boolean
}

const { title = 'Dewey', hideSearch = false } = Astro.props
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content="Documentation toolkit for AI-agent-ready docs" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content="Documentation toolkit for AI-agent-ready docs" />
    <meta property="og:image" content="/og.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <link rel="icon" type="image/png" href="/og.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display:wght@100;200;300;400;600&family=Inter:wght@300;400;500&family=Geist+Mono:wght@300;400;500&display=swap"
    />
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" />
    <script is:inline>
      ;(function () {
        try {
          var saved = localStorage.getItem('theme')
        } catch (e) {}
        var theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
        document.documentElement.setAttribute('data-theme', theme)
      })()
    </script>
    <slot name="head" />
  </head>
  <body>
    <div class="root min-h-screen bg-[var(--color-bg)] text-[var(--color-text)]" data-theme-root>
      <SiteHeader showSearch={!hideSearch} />
      <main class="mx-auto w-full max-w-[1200px] py-8" style="padding-left: clamp(20px, 4vw, 48px); padding-right: clamp(20px, 4vw, 48px);" data-pagefind-body>
        <slot />
      </main>
    </div>
    <div
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-6"
      data-search-modal
      data-pagefind-ignore
    >
      <div class="w-full max-w-2xl rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6 shadow-xl">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-widest text-[var(--color-text-muted)]">Search</p>
            <h2 class="text-lg font-semibold">Find docs fast</h2>
          </div>
          <button class="text-xs text-[var(--color-text-muted)]" data-search-close>Close</button>
        </div>
        <div id="search-modal" class="mt-4 rounded-[var(--radius-md)] border border-[var(--color-border)] bg-[var(--color-surface-muted)] p-4"></div>
        <p id="search-modal-fallback" class="mt-3 hidden text-xs text-[var(--color-text-muted)]">
          Search index is generated on build. Run <code>bun run build</code> to enable Pagefind locally.
        </p>
      </div>
    </div>
    <script is:inline>
      (() => {
        const initUi = () => {
          try {
            const themeToggle = document.querySelector('[data-theme-toggle]')

            themeToggle?.addEventListener('click', () => {
              const current = document.documentElement.getAttribute('data-theme') || 'light'
              const next = current === 'dark' ? 'light' : 'dark'
              document.documentElement.setAttribute('data-theme', next)
              try {
                localStorage.setItem('theme', next)
              } catch {}
            })

            const handleSearchShortcut = (event) => {
              const isMac = navigator.platform?.toUpperCase().includes('MAC')
              const isCmdK = isMac ? event.metaKey && event.key.toLowerCase() === 'k' : event.ctrlKey && event.key.toLowerCase() === 'k'
              if (isCmdK) {
                event.preventDefault()
                window.dispatchEvent(new CustomEvent('open-search'))
              }
            }
            window.addEventListener('keydown', handleSearchShortcut)

            const searchModal = document.querySelector('[data-search-modal]')
            const searchToggle = document.querySelector('[data-search-toggle]')
            const searchClose = document.querySelector('[data-search-close]')

            const loadPagefind = () =>
              new Promise((resolve) => {
                if (window.PagefindUI) return resolve(true)
                const existing = document.querySelector('script[data-pagefind]')
                if (existing) {
                  existing.addEventListener('load', () => resolve(true))
                  existing.addEventListener('error', () => resolve(false))
                  return
                }
                const script = document.createElement('script')
                script.src = '/pagefind/pagefind-ui.js'
                script.async = true
                script.dataset.pagefind = 'true'
                script.addEventListener('load', () => resolve(true))
                script.addEventListener('error', () => resolve(false))
                document.head.appendChild(script)
              })

            const initPagefind = async () => {
              const ok = await loadPagefind()
              if (ok && window.PagefindUI) {
                new window.PagefindUI({
                  element: '#search-modal',
                  showSubResults: true,
                })
              } else {
                document.getElementById('search-modal-fallback')?.classList.remove('hidden')
              }
            }

            const openSearch = () => {
              if (!searchModal) return
              searchModal.classList.remove('hidden')
              searchModal.classList.add('flex')
              initPagefind()
            }

            const closeSearch = () => {
              if (!searchModal) return
              searchModal.classList.add('hidden')
              searchModal.classList.remove('flex')
            }

            searchToggle?.addEventListener('click', openSearch)
            document.querySelector('[data-open-search]')?.addEventListener('click', openSearch)
            searchClose?.addEventListener('click', closeSearch)
            searchModal?.addEventListener('click', (event) => {
              if (event.target === searchModal) closeSearch()
            })
            window.addEventListener('open-search', openSearch)
          } catch (error) {
            console.error('UI init failed', error)
          }
        }

        const copySvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>'
        const checkSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>'

        const addCopyButtons = () => {
          document.querySelectorAll('pre').forEach((block) => {
            if (block.dataset.copyReady) return
            block.dataset.copyReady = 'true'
            block.style.position = 'relative'
            const btn = document.createElement('button')
            btn.innerHTML = copySvg
            btn.className = 'doc-copy-btn'
            btn.title = 'Copy code'
            btn.addEventListener('click', async () => {
              const code = block.querySelector('code')
              if (!code) return
              await navigator.clipboard.writeText(code.innerText)
              btn.innerHTML = checkSvg
              btn.classList.add('copied')
              setTimeout(() => { btn.innerHTML = copySvg; btn.classList.remove('copied') }, 1500)
            })
            block.appendChild(btn)
          })
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initUi)
          document.addEventListener('DOMContentLoaded', addCopyButtons)
        } else {
          initUi()
          addCopyButtons()
        }
      })()
    </script>
  </body>
</html>
