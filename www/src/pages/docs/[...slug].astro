---
import DocsLayout from '../../layouts/DocsLayout.astro'
import docsIndex from '../../../docs.json'

export async function getStaticPaths() {
  const markdownFiles = import.meta.glob('../../../docs/**/*.md')

  const entries = Object.entries(markdownFiles).filter(([filePath]) => {
    if (filePath.includes('/docs/agent/')) return false
    if (filePath.endsWith('.agent.md')) return false
    if (filePath.endsWith('/docs/AGENTS.md')) return false
    return true
  })

  return Promise.all(
    entries.map(async ([filePath, loader]) => {
      const page = await loader()
      const slug = filePath.split('/docs/')[1].replace(/\.md$/, '')

      return {
        params: { slug },
        props: { page, filePath },
      }
    }),
  )
}

const { page, filePath } = Astro.props
const { Content, frontmatter } = page
const headings = (await page.getHeadings?.()) ?? page.headings ?? []
const slug = filePath.split('/docs/')[1].replace(/\.md$/, '')
const fileName = slug.split('/').pop() ?? 'Docs'
const fallbackTitle = fileName
  .split('-')
  .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1))
  .join(' ')
const title = frontmatter?.title ?? fallbackTitle

const sectionId = slug.split('/')[0]
const section = docsIndex.sections.find((entry) => entry.id === sectionId)
const description = section?.description

const rawMarkdownFiles = import.meta.glob('../../../docs/**/*.md', {
  query: '?raw',
  import: 'default',
})
const agentMarkdownFiles = import.meta.glob('../../../docs/agent/**/*.agent.md', {
  query: '?raw',
  import: 'default',
})

const rawLoader = rawMarkdownFiles[filePath]
const rawMarkdown = rawLoader ? await rawLoader() : ''

const agentFilePath = filePath
  .replace('/docs/', '/docs/agent/')
  .replace(/\.md$/, '.agent.md')
const agentLoader = agentMarkdownFiles[agentFilePath]
const agentMarkdown = agentLoader ? await agentLoader() : ''

const isPrompt = slug.startsWith('prompts/')
const prompt = isPrompt ? rawMarkdown : null
const badge = isPrompt ? 'Prompt' : null
---

<DocsLayout
  title={title}
  headings={headings}
  description={description}
  badge={badge}
  rawMarkdown={rawMarkdown}
  agentMarkdown={agentMarkdown}
  prompt={prompt}
>
  <Content />
</DocsLayout>
